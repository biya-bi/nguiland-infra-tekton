apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: maven-docker-pipeline
  namespace: infra
spec:
  description: |
    This pipeline checkout a Git repository, builds a Docker image from it, and pushes the built image to a container registry.
  params:
  - name: repo-url
    type: string
  - name: context-dir
    type: string
    default: '.'
    description: >-
      The directory from which to launch the Maven build
  - name: image-name
  workspaces:
  - name: source
  - name: maven-settings
  - name: maven-local-repo
  - name: docker-config
  tasks:
  - name: fetch-source
    taskRef:
      name: git-clone
    params:
    - name: url
      value: $(params.repo-url)
    workspaces:
    - name: output
      workspace: source
  - name: build-source
    runAfter:
      - fetch-source
    taskRef:
      kind: Task
      name: maven
    params:
    - name: GOALS
      value:
        - '-pl'
        - $(params.context-dir)
        - '-B'
        - clean
        - package
    workspaces:
      - name: maven-settings
        workspace: maven-settings
      - name: source
        workspace: source
      - name: maven-local-repo
        workspace: maven-local-repo
  - name: build-image
    runAfter:
      - build-source
    taskRef:
      name: kaniko
    params:
      - name: CONTEXT
        value: $(params.context-dir)
      - name: IMAGE
        value: $(params.image-name)
      # - name: STORAGE_DRIVER
      #   value: "$(params.storageDriver)"
      - name: TLSVERIFY
        value: 'false'
    workspaces:
      - name: source
        workspace: source
      - name: dockerconfig
        workspace: docker-config